#!/bin/bash

#
# sudo (with keep-alive)
#
get_sudo() {
	sudo -v
	while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}

#
# logger func
#
log() {
	local msg=$1
	local timestamp=$(/bin/date "+%Y-%m-%d %H:%M:%S %z")
	local message="${timestamp} [setup_mac] ${msg}"
	if [[ -n "${msg}" ]];
	then
		echo "${message}"
	fi
}

#
# install packages
#
install_packages() {
	get_sudo
	local packages=(
		'cmake'
		'docker'
		'dos2unix'
		'gcc'
		'gcc-c++'
		'git'
		'openssl'
		'ruby'
		'subversion'
		'tree'
		'unzip'
		'wget'
		'vim-enhanced'
	)

	log "install_packages initializing"
	sudo yum clean all
	sudo yum makecache
	sudo yum update -y
	sudo yum install -y "${packages[@]}"
	log "install_packages terminating"
}

#
# install git (from source)
#
install_git() {
	local git_version="2.7.0"
	local git_source="https://github.com/git/git/archive/v${git_version}.tar.gz"

	(
		# get source
		curl -sSL "${git_source}" | tar -v -C /usr/local/src -zx
		cd "/usr/local/src/git-${git_version}" && sudo make configure

		# configure
		sudo ./configure

		# build binary and install
		sudo make && sudo make install
	)
}

#
# install hub (from source)
#
install_hub() {
	local hub_version="2.2.2"
	local hub_tarball="https://github.com/github/hub/releases/download/v${hub_version}/hub-linux-amd64-${hub_version}.tgz"

	(
		sudo curl -sSL "${hub_tarball}" | sudo tar -v -C /usr/local/src -zx
		cd "/usr/local/src/hub-linux-amd64-${hub_version}" && sudo ./install
	)
}

#
# setup dotfiles (bash/vim)
#
setup_dotfiles() {
	if [[ $USER == 'root' ]];
	then
		local homedir="/${USER}"
	else
		local homedir="/home/${USER}"
	fi
	local vimfiles='https://github.com/wafture/vimfiles.git'

	(
		git clone "${vimfiles}" "${homedir}/vimfiles"
		cd "${homedir}/vimfiles" && make
	)
}

#
# install golang and packages
#
setup_go() {
	local go_version="1.6"
	local go_source="/usr/local/go"

	if [[ -d "${go_source}" ]];
	then
		sudo rm -rf "${go_source}"
	fi

	# go
	(
		curl -sSL "https://storage.googleapis.com/golang/go${go_version}.linux-amd64.tar.gz" | sudo tar -v -C /usr/local -zx
	)

	# go packages
	(
		go get -v golang.org/x/tools/cmd/cover
		go get -v golang.org/x/tools/cmd/vet
		go get -v golang.org/x/tools/cmd/goimports
		go get -v golang.org/x/tools/cmd/oracle
		go get -v golang.org/x/tools/cmd/gorename
		go get -v github.com/golang/lint/golint

		go get -v github.com/nsf/gocode
		go get -v github.com/rogpeppe/godef
		go get -v github.com/golang/lint/golint
		go get -v github.com/alecthomas/kingpin
		go get -v github.com/alecthomas/gometalinter
		go get -v github.com/kisielk/errcheck
		go get -v github.com/jstemmer/gotags
		go get -v github.com/klauspost/asmfmt/cmd/asmfmt

		go get -v github.com/wafture/log
		go get -v github.com/wafture/godap
	)
}

#
# bootstrap my machine
#
log "installing packages and apps"
install_packages
log "installing git from source"
install_git
log "installing hub from source"
install_hub
log "setting up dotfiles"
setup_dotfiles
log "installing golang and packages"
setup_go
