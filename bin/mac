#!/bin/bash
#
# MAC Bootstrap Script
#
set -e

#
# get sudo
#
get_sudo() {
  sudo -v
  while true;
  do
    sudo -n true;
    sleep 60;
    kill -0 "$$" || exit;
  done 2>/dev/null &
}

#
# write log
#
write_log() {
  if [[ -n "${1}" ]];
  then
    local datestamp=$(/bin/date "+%Y-%m-%d %H:%M:%S %z")
    echo "${datestamp} make::mac::${1}"
  fi
}

#
# install brew
#
brew_install() {
  write_log "${FUNCNAME[0]} => init"

  local github_url='https://raw.githubusercontent.com'
  local brew_install_url="${github_url}/Homebrew/install/master/install"

  # return early if already installed
  if command -v brew >/dev/null;
  then
    return 0
  fi

  # install brew
  (
    curl -fsSL "${brew_install_url}" | ruby
  )

  write_log "${FUNCNAME[0]} => done"
}

#
# brew $action
# aka: brew upgrade, brew clean
#
brew_action() {
  write_log "${FUNCNAME[0]} => init"

  local brew_act="${1}"
  local brew_arg="${2}"
  local brew_cmd=$(which brew)
  write_log "${FUNCNAME[0]} action => ${brew_act} ${brew_arg}"

  # run specified brew cmd
  (
    $brew_cmd $brew_act $brew_arg
  )

  write_log "${FUNCNAME[0]} => done"
}

#
# install brew bottles
#
brew_install_bottles() {
  write_log "${FUNCNAME[0]} => init"

  local brew_bottles=(
    'ansible'
    'bash'
    'bash-completion2'
    'fping'
    'git'
    'hub'
    'jq'
    'lua'
    'openssl'
    'shellcheck'
    'subversion'
    'tree'
    'vagrant-completion'
    'vim'
  )

  # tap up
  brew_action "tap" "homebrew/completions"
  brew_action "tap" "homebrew/versions"

  # install bottles
  (
    for bottle in "${brew_bottles[@]}"
    do
      brew_action "install" "${bottle}"
    done
  )

  write_log "${FUNCNAME[0]} => done"
}

#
# setup: entry point
#
main() {
  write_log "${FUNCNAME[0]} => init"

  # install & setup brew
  brew_install
  brew_action "upgrade"

  # install bottles
  brew_install_bottles

  # cleanup install of brew
  brew_action "update"
  brew_action "prune"
  brew_action "cleanup"

  write_log "${FUNCNAME[0]} => done"
}
main
